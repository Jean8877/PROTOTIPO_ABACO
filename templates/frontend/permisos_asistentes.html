<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gesti贸n de Usuarios - Di贸cesis</title>
    <link rel="stylesheet" href="/static/css/general.css">
    <link rel="stylesheet" href="/static/css/permisos_asistentes.css">
    <link rel="shortcut icon" href="/static/images/imagen.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
</head>

<body>

    <!-- HEADER -->
    <header>
        <img src="/static/images/imagen.png" alt="logo de abaco">
        <h5 class="mb-0">Sistema de Inventario y Donaciones, <strong>DIOCESIS</strong></h5>
        <div>
            <i class="bi bi-person-circle"></i>
            <span class="me-3"> <strong>{{usuario}}</strong> </span>
            <i class="bi bi-bell-fill me-3" style="cursor: pointer;" onclick="mostrarNotificaciones()"></i>
        </div>
    </header>

    <!-- LAYOUT: SIDEBAR + CONTENT -->
    <div class="main-layout">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <a href="{{ url_for('rutas_dp.menu_central') }}"><i class="bi bi-house-door-fill"></i><span>Inicio</span></a>
            <a href="{{ url_for('rutas_dp.menu_de_parroquias') }}"><i class="bi bi-bank"></i><span>Organizaciones</span></a>
            <a href="{{ url_for('rutas_dp.menu_producto') }}"><i class="bi bi-bookmark-plus"></i><span>Productos</span></a>
            <a href="{{ url_for('rutas_dp.menu_donante') }}"><i class="bi bi-people-fill"></i><span>Donantes</span></a>
            <a href="{{ url_for('rutas_dp.pagina_principal') }}"><i class="bi bi-heart-fill"></i><span>Donaciones</span></a>
            <a href="{{ url_for('rutas_dp.lista_donaciones') }}"><i class="bi bi-bag-check"></i><span>Lista de Donaciones</span></a>
            <a href="{{ url_for('rutas_dp.tabla_producto') }}"><i class="bi bi-table"></i><span>Tabla de Productos</span></a>
            <a href="{{ url_for('rutas_dp.movimiento_inv') }}"><i class="bi bi-box-seam"></i><span>Inventario</span></a>
            <a href="{{ url_for('rutas_dp.menu_gastos') }}"><i class="bi bi-coin"></i><span>Gastos</span></a>
            <a href="{{ url_for('rutas_dp.menu_reportes') }}"><i class="bi bi-graph-up"></i><span>Reportes</span></a>
            <a href="{{ url_for('rutas_dp.pag_confi') }}"><i class="bi bi-gear-fill"></i><span>Configuraci贸n</span></a>
            <a class="mt-auto" style="cursor: row-resize;" onclick="cerrar()"><i
                    class="bi bi-box-arrow-left"></i><span>Cerrar sesi贸n</span></a>
        </div>

        <!-- CONTENIDO -->
             <div class="container my-4">
            <div class="container bg-white p-4 rounded shadow">
                <div class="row justify-content-center">
                    <div class="col-12 col-lg-10">
                        <!--  Bot贸n de regresar en la esquina del formulario -->
                        <a href="{{ url_for('rutas_dp.pag_confi') }}" class="btn btn-outline-success btn-sm position-absolute">
                            <i class="bi bi-arrow-left"></i>
                        </a>
                        <h2 class="mb-4 text-center"> Gesti贸n de Usuarios</h2>

                        <div class="accordion" id="accordionUsuarios">
                            <!-- Usuarios Registrados -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingOne">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                        Usuarios Registrados
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse show"
                                    aria-labelledby="headingOne" data-bs-parent="#accordionUsuarios">
                                    <div class="accordion-body">
                                        <div id="listaUsuarios" class="row g-4"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Registrar Usuario -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingTwo">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                        Registrar Usuario
                                    </button>
                                </h2>
                                <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
                                    data-bs-parent="#accordionUsuarios">
                                    <div class="accordion-body">
                                        <form id="formUsuario">
                                            <div class="mb-3">
                                                <label for="nombreUsuario" class="form-label">Nombre completo</label>
                                                <input type="text" id="nombreUsuario" class="form-control" required>
                                            </div>

                                            <div class="mb-3">
                                                <label for="username" class="form-label">Usuario</label>
                                                <input type="text" id="username" class="form-control" required>
                                            </div>

                                            <div class="mb-3">
                                                <label for="correo" class="form-label">Correo electr贸nico</label>
                                                <input type="email" id="correo" class="form-control">
                                            </div>

                                            <div class="mb-3">
                                                <label for="password" class="form-label">Contrase帽a</label>
                                                <input type="password" id="password" class="form-control" required>
                                            </div>

                                            <div class="mb-3">
                                                <label for="confirmPassword" class="form-label">Confirmar
                                                    Contrase帽a</label>
                                                <input type="password" id="confirmPassword" class="form-control"
                                                    required>
                                            </div>

                                            <div class="mb-3">
                                                <label for="rol" class="form-label">Rol de usuario</label>
                                                <select id="rol" class="form-select">
                                                    <option value="admin">Administrador</option>
                                                    <option value="asistente">Asistente</option>
                                                    <option value="voluntario">Voluntario</option>
                                                </select>
                                            </div>

                                            <div class="d-flex justify-content-between">
                                                <button type="submit" class="btn btn-success btn-custom">Guardar
                                                    Usuario</button>
                                                <button type="reset"
                                                    class="btn btn-secondary btn-custom">Limpiar</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <script>
            const form = document.getElementById('formUsuario');
            const listaUsuarios = document.getElementById('listaUsuarios');

            function obtenerUsuarios() {
                return JSON.parse(localStorage.getItem("usuariosConfig")) || [];
            }

            function guardarUsuarios(usuarios) {
                localStorage.setItem("usuariosConfig", JSON.stringify(usuarios));
            }

            function mostrarUsuarios() {
                listaUsuarios.innerHTML = "";
                const usuarios = obtenerUsuarios();

                if (usuarios.length === 0) {
                    listaUsuarios.innerHTML = "<p class='text-center text-muted'>No hay usuarios registrados.</p>";
                    return;
                }

                usuarios.forEach((u, index) => {
                    const col = document.createElement("div");
                    col.className = "col-12 col-md-6 col-lg-4";
                    col.innerHTML = `
          <div class="user-card h-100">
            <h5 class="text-primary">${u.nombre}</h5>
            <p class="mb-1"><strong>Usuario:</strong> ${u.username}</p>
            <p class="mb-1"><strong>Rol:</strong> ${u.rol}</p>
            <p><strong>Correo:</strong> ${u.correo || "No registrado"}</p>
            <div class="d-flex justify-content-between">
              <button class="btn btn-warning btn-sm" onclick="editarUsuario(${index})">锔 Editar</button>
              <button class="btn btn-danger btn-sm" onclick="eliminarUsuario(${index})"> Eliminar</button>
            </div>
          </div>
        `;
                    listaUsuarios.appendChild(col);
                });
            }

            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const nombre = document.getElementById('nombreUsuario').value;
                const username = document.getElementById('username').value;
                const correo = document.getElementById('correo').value;
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const rol = document.getElementById('rol').value;

                if (password !== confirmPassword) {
                    swal("Advertencia", "Las contrase帽as no coinciden", "warning");

                    return;
                }


                let usuarios = obtenerUsuarios();
                usuarios.push({ nombre, username, correo, password, rol });
                guardarUsuarios(usuarios);
                mostrarUsuarios();
                form.reset();
                swal("Mensaje", "Usuario guardado correctamente.", "success");
            });


            function editarUsuario(index) {
                const usuarios = obtenerUsuarios();
                const u = usuarios[index];

                document.getElementById('nombreUsuario').value = u.nombre;
                document.getElementById('username').value = u.username;
                document.getElementById('correo').value = u.correo;
                document.getElementById('password').value = u.password;
                document.getElementById('confirmPassword').value = u.password;
                document.getElementById('rol').value = u.rol;

                usuarios.splice(index, 1);
                guardarUsuarios(usuarios);
                mostrarUsuarios();

                let collapseTwo = new bootstrap.Collapse(document.getElementById('collapseTwo'), { toggle: true });
            }

            function eliminarUsuario(index) {
                let usuarios = obtenerUsuarios();
                usuarios.splice(index, 1);
                guardarUsuarios(usuarios);
                mostrarUsuarios();
                swal("Mensaje", "Usuario eliminado correctamente.", "warning");
            }

            window.addEventListener("load", mostrarUsuarios);
        </script>
        <script>
            resaltar()
        </script>
        <!-- Bootstrap JS (requerido para el acorde贸n) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <script src="/static/js/resaltar.js"></script>
        <script src="/static/js/notificacion.js"></script>

</body>

</html>